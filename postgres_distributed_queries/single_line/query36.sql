SELECT CAST(SUM(ss_net_profit) AS DOUBLE) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING(i_category) + GROUPING(i_class) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(i_category) + GROUPING(i_class), CASE WHEN GROUPING(i_class) = 0 THEN i_category END ORDER BY CAST(SUM(ss_net_profit) AS DOUBLE) / SUM(ss_ext_sales_price) ASC NULLS FIRST) AS rank_within_parent FROM postgres2.public.store_sales, postgres2.public.date_dim AS d1, postgres3.public.item, postgres1.public.store WHERE d1.d_year = 2000 AND d1.d_date_sk = ss_sold_date_sk AND i_item_sk = ss_item_sk AND s_store_sk = ss_store_sk AND s_state IN ('TN', 'TN', 'TN', 'TN', 'TN', 'TN', 'TN', 'TN') GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END NULLS FIRST, rank_within_parent NULLS FIRST LIMIT 100